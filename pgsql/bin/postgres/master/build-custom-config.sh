#!/usr/bin/env bash

CONFIG_FILE="${PGDATA}/postgresql.conf"

echo "[master/configure] Configuring ${CONFIG_FILE}"
cp -f /var/cluster_configs/postgresql.conf "${CONFIG_FILE}"
echo "
#------------------------------------------------------------------------------
# AUTOGENERATED
#------------------------------------------------------------------------------
" >> "${CONFIG_FILE}"

IFS=',' read -ra CONFIG_PAIRS <<< "${PG_CUSTOM_CONFIG}"
for CONFIG_PAIR in "${CONFIG_PAIRS[@]}"
do
    IFS=':' read -ra CONFIG <<< "${CONFIG_PAIR}"
    VAR="${CONFIG[0]}"
    VAL="${CONFIG[1]}"
    sed -e "s/\(^\ *${VAR}\(.*\)$\)/#\1 # overrided in AUTOGENERATED section/g"
    echo "[master/configure] adding config '${VAR}'='${VAL}' "
    echo "${VAR} = ${VAL}" >> "${CONFIG_FILE}"
done
